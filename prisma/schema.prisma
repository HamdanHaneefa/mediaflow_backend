// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE CRM TABLES
// ============================================================================

model contacts {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  email      String   @unique
  phone      String?
  company    String?
  role       String   @default("Client")
  status     String   @default("Active")
  notes      String?
  tags       String[] @default([])
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  projects_as_client projects[]        @relation("ClientProjects")
  tasks_assigned     tasks[]
  income_records     income[]
  proposals          proposals[]
  client_user        client_users?

  @@index([email])
  @@index([role])
  @@index([status])
}

model projects {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title        String
  description  String?
  type         String   @default("Commercial")
  status       String   @default("Active")
  phase        String   @default("Pre-production")
  client_id    String?  @db.Uuid
  budget       Decimal? @db.Decimal(12, 2)
  start_date   DateTime? @db.Date
  end_date     DateTime? @db.Date
  team_members String[] @default([]) @db.Uuid
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  updated_at   DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  client               contacts?                  @relation("ClientProjects", fields: [client_id], references: [id], onDelete: SetNull)
  tasks                tasks[]
  expenses             expenses[]
  income               income[]
  proposals            proposals[]
  events               events[]
  assets               assets[]
  team_project_assignments team_project_assignments[]
  financial_transactions financial_transactions[]
  project_assignments  project_assignments[]
  client_messages      client_messages[]
  client_documents     client_documents[]
  project_comments     project_comments[]

  @@index([client_id])
  @@index([status])
  @@index([phase])
}

model tasks {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  status      String    @default("To Do")
  project_id  String?   @db.Uuid
  assigned_to String?   @db.Uuid
  due_date    DateTime? @db.Date
  priority    String    @default("Medium")
  type        String    @default("Administrative")
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  project  projects? @relation(fields: [project_id], references: [id], onDelete: Cascade)
  assignee contacts? @relation(fields: [assigned_to], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([assigned_to])
  @@index([status])
}

// ============================================================================
// TEAM MANAGEMENT TABLES
// ============================================================================

model team_members {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id              String?   @db.Uuid
  first_name           String?
  last_name            String?
  email                String    @unique
  password             String?
  phone                String?
  avatar_url           String?
  role                 String    @default("member")
  position             String?
  department           String?
  status               String    @default("active")
  permissions          Json      @default("{}")
  hourly_rate          Decimal?  @db.Decimal(8, 2)
  emergency_contact    Json?
  skills               String[]  @default([])
  bio                  String?
  hire_date            DateTime? @default(now()) @db.Date
  assigned_projects    String[]  @default([]) @db.Uuid
  performance_metrics  Json?
  invitation_status    String?   @default("Accepted")
  invited_at           DateTime? @db.Timestamptz(6)
  invited_by           String?   @db.Uuid
  last_active          DateTime? @default(now()) @db.Timestamptz(6)
  team_id              String?   @db.Uuid
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  team                    teams?                    @relation("TeamMembers", fields: [team_id], references: [id], onDelete: SetNull)
  managed_teams           teams[]                   @relation("TeamManager")
  created_teams           teams[]                   @relation("TeamCreator")
  invited_members         team_members[]            @relation("MemberInviter")
  inviter                 team_members?             @relation("MemberInviter", fields: [invited_by], references: [id], onDelete: SetNull)
  sent_invitations        team_invitations[]        @relation("InvitationSender")
  project_assignments     project_assignments[]     @relation("AssignedMember")
  assigned_by_projects    project_assignments[]     @relation("AssignmentAssigner")
  team_assignments        team_project_assignments[] @relation("TeamAssignmentAssigner")
  expenses_submitted      expenses[]                @relation("ExpenseSubmitter")
  expenses_approved       expenses[]                @relation("ExpenseApprover")

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([team_id])
}

model teams {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  manager_id  String?  @db.Uuid
  member_ids  String[] @default([]) @db.Uuid
  project_ids String[] @default([]) @db.Uuid
  created_by  String?  @db.Uuid
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  manager                  team_members?              @relation("TeamManager", fields: [manager_id], references: [id], onDelete: SetNull)
  creator                  team_members?              @relation("TeamCreator", fields: [created_by], references: [id], onDelete: SetNull)
  members                  team_members[]             @relation("TeamMembers")
  team_project_assignments team_project_assignments[]

  @@index([manager_id])
  @@index([name])
}

model team_invitations {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email            String
  role             String   @default("Assistant")
  permissions      Json     @default("{}")
  invited_by       String?  @db.Uuid
  invitation_token String   @unique
  expires_at       DateTime @db.Timestamptz(6)
  status           String   @default("Pending")
  message          String?
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  inviter team_members? @relation("InvitationSender", fields: [invited_by], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([invitation_token])
  @@index([status])
}

model project_assignments {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id           String    @db.Uuid
  team_member_id       String    @db.Uuid
  role_in_project      String
  assigned_at          DateTime  @default(now()) @db.Timestamptz(6)
  assigned_by          String?   @db.Uuid
  is_lead              Boolean   @default(false)
  responsibilities     String[]  @default([])
  hourly_rate_override Decimal?  @db.Decimal(8, 2)

  // Relations
  project     projects      @relation(fields: [project_id], references: [id], onDelete: Cascade)
  team_member team_members  @relation("AssignedMember", fields: [team_member_id], references: [id], onDelete: Cascade)
  assigner    team_members? @relation("AssignmentAssigner", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([team_member_id])
}

model team_project_assignments {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  team_id     String   @db.Uuid
  project_id  String   @db.Uuid
  assigned_at DateTime @default(now()) @db.Timestamptz(6)
  assigned_by String?  @db.Uuid

  // Relations
  team     teams         @relation(fields: [team_id], references: [id], onDelete: Cascade)
  project  projects      @relation(fields: [project_id], references: [id], onDelete: Cascade)
  assigner team_members? @relation("TeamAssignmentAssigner", fields: [assigned_by], references: [id], onDelete: SetNull)

  @@unique([team_id, project_id])
  @@index([team_id])
  @@index([project_id])
}

// ============================================================================
// ACCOUNTING & FINANCE TABLES
// ============================================================================

model expenses {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id       String?   @db.Uuid
  title            String
  description      String?
  amount           Decimal   @db.Decimal(12, 2)
  category         String
  expense_date     DateTime  @db.Date
  receipt_url      String?
  receipt_filename String?
  vendor           String?
  status           String    @default("Draft")
  submitted_by     String?   @db.Uuid
  approved_by      String?   @db.Uuid
  approved_at      DateTime? @db.Timestamptz(6)
  rejection_reason String?
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  project                projects?                   @relation(fields: [project_id], references: [id], onDelete: SetNull)
  submitter              team_members?               @relation("ExpenseSubmitter", fields: [submitted_by], references: [id], onDelete: SetNull)
  approver               team_members?               @relation("ExpenseApprover", fields: [approved_by], references: [id], onDelete: SetNull)
  financial_transactions financial_transactions[]

  @@index([project_id])
  @@index([category])
  @@index([status])
  @@index([submitted_by])
  @@index([expense_date])
}

model income {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id     String?   @db.Uuid
  title          String
  description    String?
  amount         Decimal   @db.Decimal(12, 2)
  income_type    String
  expected_date  DateTime? @db.Date
  received_date  DateTime? @db.Date
  status         String    @default("Expected")
  invoice_number String?
  client_id      String?   @db.Uuid
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  project                projects?                   @relation(fields: [project_id], references: [id], onDelete: SetNull)
  client                 contacts?                   @relation(fields: [client_id], references: [id], onDelete: SetNull)
  financial_transactions financial_transactions[]

  @@index([project_id])
  @@index([client_id])
  @@index([status])
  @@index([expected_date])
}

model financial_transactions {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id       String?   @db.Uuid
  type             String
  income_id        String?   @db.Uuid
  expense_id       String?   @db.Uuid
  amount           Decimal   @db.Decimal(12, 2)
  description      String
  transaction_date DateTime  @db.Date
  status           String    @default("Pending")
  reference_number String?
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  project projects? @relation(fields: [project_id], references: [id], onDelete: SetNull)
  income  income?   @relation(fields: [income_id], references: [id], onDelete: SetNull)
  expense expenses? @relation(fields: [expense_id], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([type])
  @@index([transaction_date])
}

// ============================================================================
// PROPOSALS TABLE
// ============================================================================

model proposals {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title             String
  client_id         String    @db.Uuid
  project_id        String?   @db.Uuid
  status            String    @default("Draft")
  total_amount      Decimal   @db.Decimal(12, 2)
  valid_until       DateTime  @db.Date
  terms             String?
  notes             String?
  items             Json      @default("[]")
  pdf_url           String?
  sent_at           DateTime? @db.Timestamptz(6)
  viewed_at         DateTime? @db.Timestamptz(6)
  accepted_at       DateTime? @db.Timestamptz(6)
  rejected_at       DateTime? @db.Timestamptz(6)
  rejection_reason  String?
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  client  contacts  @relation(fields: [client_id], references: [id], onDelete: Cascade)
  project projects? @relation(fields: [project_id], references: [id], onDelete: SetNull)
  proposal_responses proposal_responses[]

  @@index([client_id])
  @@index([project_id])
  @@index([status])
}

// ============================================================================
// SCHEDULING & CALENDAR TABLES
// ============================================================================

model events {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  type        String    @default("Meeting")
  start_time  DateTime  @db.Timestamptz(6)
  end_time    DateTime  @db.Timestamptz(6)
  location    String?
  project_id  String?   @db.Uuid
  attendees   String[]  @default([]) @db.Uuid
  color       String?
  is_all_day  Boolean   @default(false)
  recurrence  Json?
  reminder    Json?
  status      String    @default("Scheduled")
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  project projects? @relation(fields: [project_id], references: [id], onDelete: SetNull)

  @@index([project_id])
  @@index([start_time])
  @@index([end_time])
  @@index([status])
}

// ============================================================================
// ASSET MANAGEMENT TABLE
// ============================================================================

model assets {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  description       String?
  type              String
  category          String?
  status            String    @default("Available")
  location          String?
  purchase_date     DateTime? @db.Date
  purchase_price    Decimal?  @db.Decimal(12, 2)
  current_value     Decimal?  @db.Decimal(12, 2)
  serial_number     String?
  manufacturer      String?
  model             String?
  condition         String?
  maintenance_schedule Json?
  last_maintenance  DateTime? @db.Date
  next_maintenance  DateTime? @db.Date
  assigned_to       String?   @db.Uuid
  assigned_project  String?   @db.Uuid
  files             Json?
  notes             String?
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  project projects? @relation(fields: [assigned_project], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([status])
  @@index([assigned_project])
}

// ============================================================================
// CLIENT PORTAL TABLES
// ============================================================================

model client_users {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contact_id           String    @unique @db.Uuid
  email                String    @unique
  password_hash        String
  is_verified          Boolean   @default(false)
  verification_token   String?   @unique
  reset_token          String?   @unique
  reset_token_expires  DateTime? @db.Timestamptz(6)
  last_login           DateTime? @db.Timestamptz(6)
  is_active            Boolean   @default(true)
  created_at           DateTime  @default(now()) @db.Timestamptz(6)
  updated_at           DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  contact       contacts               @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  sessions      client_sessions[]
  notifications client_notifications[]
  messages      client_messages[]
  documents     client_documents[]
  activities    client_activities[]

  @@index([email])
  @@index([contact_id])
  @@index([verification_token])
  @@index([reset_token])
}

model client_sessions {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_user_id String   @db.Uuid
  token          String   @unique
  ip_address     String?
  user_agent     String?
  expires_at     DateTime @db.Timestamptz(6)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  client_user client_users @relation(fields: [client_user_id], references: [id], onDelete: Cascade)

  @@index([client_user_id])
  @@index([token])
  @@index([expires_at])
}

model client_notifications {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_user_id String   @db.Uuid
  type           String   // invoice, proposal, project, message, document, payment
  title          String
  message        String
  link           String?
  metadata       Json?
  is_read        Boolean  @default(false)
  read_at        DateTime? @db.Timestamptz(6)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  client_user client_users @relation(fields: [client_user_id], references: [id], onDelete: Cascade)

  @@index([client_user_id])
  @@index([type])
  @@index([is_read])
  @@index([created_at])
}

model client_messages {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_user_id String    @db.Uuid
  project_id     String?   @db.Uuid
  sender_type    String    // client or team
  sender_id      String    @db.Uuid
  sender_name    String
  subject        String?
  message        String    @db.Text
  attachments    Json?
  is_read        Boolean   @default(false)
  read_at        DateTime? @db.Timestamptz(6)
  parent_id      String?   @db.Uuid
  created_at     DateTime  @default(now()) @db.Timestamptz(6)

  // Relations
  client_user client_users        @relation(fields: [client_user_id], references: [id], onDelete: Cascade)
  project     projects?           @relation(fields: [project_id], references: [id], onDelete: Cascade)
  parent      client_messages?    @relation("MessageReplies", fields: [parent_id], references: [id], onDelete: SetNull)
  replies     client_messages[]   @relation("MessageReplies")

  @@index([client_user_id])
  @@index([project_id])
  @@index([sender_type])
  @@index([is_read])
  @@index([parent_id])
  @@index([created_at])
}

model client_documents {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_user_id String   @db.Uuid
  project_id     String?  @db.Uuid
  filename       String
  original_name  String
  file_path      String
  file_size      Int
  mime_type      String
  uploaded_by    String   // client or team
  uploader_id    String   @db.Uuid
  uploader_name  String
  description    String?
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  client_user client_users @relation(fields: [client_user_id], references: [id], onDelete: Cascade)
  project     projects?    @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([client_user_id])
  @@index([project_id])
  @@index([uploaded_by])
  @@index([created_at])
}

model client_activities {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_user_id String   @db.Uuid
  action         String   // login, logout, view_invoice, download_proposal, etc.
  entity_type    String?  // project, invoice, proposal, document, message
  entity_id      String?  @db.Uuid
  metadata       Json?
  ip_address     String?
  user_agent     String?
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  client_user client_users @relation(fields: [client_user_id], references: [id], onDelete: Cascade)

  @@index([client_user_id])
  @@index([action])
  @@index([entity_type])
  @@index([created_at])
}

model proposal_responses {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  proposal_id    String   @db.Uuid
  client_user_id String   @db.Uuid
  status         String   // accepted, rejected, changes_requested
  comments       String?  @db.Text
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  proposal proposals @relation(fields: [proposal_id], references: [id], onDelete: Cascade)

  @@index([proposal_id])
  @@index([client_user_id])
  @@index([status])
  @@index([created_at])
}

model project_comments {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  project_id     String   @db.Uuid
  client_user_id String   @db.Uuid
  comment        String   @db.Text
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  // Relations
  project projects @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@index([client_user_id])
  @@index([created_at])
}
